<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Audio Base64 Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        audio {
            width: 100%;
            margin-top: 10px;
        }
        #log {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #ddd;
            padding-left: 10px;
        }
        .log-success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .log-error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .log-info {
            border-left-color: #007bff;
            background: #d1ecf1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Direct Audio Base64 Playback Test</h1>
        <p>Testing the exact audio data received from Volcengine TTS API</p>
        
        <div class="status">
            <h3>Test: "‰∏çÂÅúÁöÑÊµãËØïÔºåÂÜçÊµãËØïÔºåÂ≠ó‰ΩìÂá∫‰∏çÂá∫Êù•Ôºü"</h3>
            <button onclick="fetchAndPlay()">Fetch from API and Play</button>
            <button onclick="testSavedAudio()">Test Saved Audio File</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>
        
        <audio id="audioPlayer" controls></audio>
        
        <div id="log"></div>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logEl.insertBefore(entry, logEl.firstChild);
        };
        
        const clearLog = () => {
            document.getElementById('log').innerHTML = '';
        };
        
        async function fetchAndPlay() {
            const audioEl = document.getElementById('audioPlayer');
            log('Starting API fetch...', 'info');
            
            try {
                // Call the API directly
                const response = await fetch('/api/tts/synthesize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: '‰∏çÂÅúÁöÑÊµãËØïÔºåÂÜçÊµãËØïÔºåÂ≠ó‰ΩìÂá∫‰∏çÂá∫Êù•Ôºü',
                        voice: 'S_r3YGBCoB1',
                        speed: 1.1,
                        volume: 1.0,
                        pitch: 1.0,
                        encoding: 'mp3',
                    }),
                });
                
                const result = await response.json();
                log(`API Response: success=${result.success}`, result.success ? 'success' : 'error');
                
                if (!result.success || !result.audio) {
                    throw new Error(result.error || 'No audio data received');
                }
                
                // Log audio data details
                log(`Audio data length: ${result.audio.length} chars`, 'info');
                log(`First 50 chars: ${result.audio.substring(0, 50)}`, 'info');
                
                // Create data URL and set to audio element
                const dataUrl = `data:audio/mp3;base64,${result.audio}`;
                
                // Set up event handlers before setting src
                audioEl.onloadedmetadata = () => {
                    log(`‚úÖ Metadata loaded - Duration: ${audioEl.duration}s`, 'success');
                };
                
                audioEl.oncanplay = () => {
                    log('‚úÖ Audio can play', 'success');
                };
                
                audioEl.onplay = () => {
                    log('‚ñ∂Ô∏è Audio started playing', 'success');
                };
                
                audioEl.onended = () => {
                    log('‚èπÔ∏è Audio playback ended', 'info');
                };
                
                audioEl.onerror = (e) => {
                    log(`‚ùå Audio error: ${e.type}`, 'error');
                    console.error('Full error:', e);
                };
                
                // Set the source
                log('Setting audio source...', 'info');
                audioEl.src = dataUrl;
                
                // Try to play
                log('Attempting to play audio...', 'info');
                await audioEl.play();
                log('‚úÖ Audio playing successfully!', 'success');
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        async function testSavedAudio() {
            const audioEl = document.getElementById('audioPlayer');
            log('Testing saved audio file...', 'info');
            
            try {
                // Load one of the saved audio files
                audioEl.src = 'audio-problematic-text-1757402423857.mp3';
                
                audioEl.onloadedmetadata = () => {
                    log(`‚úÖ Saved file loaded - Duration: ${audioEl.duration}s`, 'success');
                };
                
                audioEl.oncanplay = () => {
                    log('‚úÖ Saved file can play', 'success');
                };
                
                audioEl.onerror = (e) => {
                    log(`‚ùå Saved file error: ${e.type}`, 'error');
                };
                
                await audioEl.play();
                log('‚úÖ Saved file playing!', 'success');
                
            } catch (error) {
                log(`‚ùå Error playing saved file: ${error.message}`, 'error');
            }
        }
        
        // Auto-fetch on page load
        window.addEventListener('load', () => {
            log('Page loaded, ready for testing', 'info');
        });
    </script>
</body>
</html>